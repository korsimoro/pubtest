<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Implementing the JSON-LD RSA Signature Suite 2017 - RWoT DIR Launchpad</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Implementing the JSON-LD RSA Signature Suite 2017", url: "#_top", children: [
              {title: "Source of Truth", url: "#source-of-truth" },
              {title: "Creating JSON-LD signatures with JSON-LD RSA 2017 Signature Suite", url: "#creating-json-ld-signatures-with-json-ld-rsa-2017-signature-suite" },
              {title: "Steps to verify", url: "#steps-to-verify" },
              {title: "Problems encountered", url: "#problems-encountered" },
              {title: "Modifications to javascript JSON-LD signature library to support RsaSignature2017", url: "#modifications-to-javascript-json-ld-signature-library-to-support-rsasignature2017" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="implementing-the-json-ld-rsa-signature-suite-2017">Implementing the JSON-LD RSA Signature Suite 2017</h1>
<p>By Kim Hamilton Duffy, Rodolphe Marques, Markus Sabadello</p>
<p>This describes specific steps and issues with implementing the RSA Signature Suite 2017.</p>
<p>This document assumes familiarity with JSON-LD signatures, and focuses on the specific changes to the algorithm to generate RSA Signature Suite 2017 signatures. Note that many of these steps should be performed by a detached payload aware JWS library.</p>
<h2 id="source-of-truth">Source of Truth</h2>
<p>RFC 7797 does not include an RS256 testcase, so we created a source of trust using the one JOSE <a href="https://github.com/Spomky-Labs/jose">implementation</a> (PHP) that implemented the RFC 7797 spec. We created a detached payload / RS256 unit test to obtain a source of truth.</p>
<pre><code class="php">
    public function testCompactJSONWithUnencodedDetachedPayloadRS256()
    {
        $payload = '$.02';
        $protected_header = [
            'alg'  =&gt; 'RS256',
            'b64'  =&gt; false,
            'crit' =&gt; ['b64'],
        ];

        $key = JWKFactory::createFromKeyFile(
            __DIR__.'/../Unit/Keys/RSA/private.encrypted.key',
            'tests', // password for key
            [
                'kid' =&gt; 'My Private RSA key',
                'use' =&gt; 'sig',
            ] // these options do not affect outcome of this test
        );

        $jws = JWSFactory::createJWSWithDetachedPayloadToCompactJSON($payload, $key, $protected_header);
        $this-&gt;assertEquals('eyJhbGciOiJSUzI1NiIsImI2NCI6ZmFsc2UsImNyaXQiOlsiYjY0Il19..fZRkjTTrcXdUovHjghM6JvlMhJuR1s8X1F4Uy_F4oMhZ9KtF2Zp78lYSOI7OxB5uoTu8FpQHvy-dz3N4nLhoSWAi2_HrxZG_2DyctUUB_8pRKYBmIdIgpOlEMjIreOvXyM6A32gR-PdbzoQq14yQbbfxk12jyZSwcaNu29gXnW_uO7ku1GSV_juWE5E_yIstvEB1GG8ApUGIuzRJDrAAa8KBkHN7Rdfhc8rJMOeSZI0dc_A-Y7t0M0RtrgvV_FhzM40K1pwr1YUZ5y1N4QV13M5u5qJ_lBK40WtWYL5MbJ58Qqk_-Q8l1dp6OCmoMvwdc7FmMsPigmyklqo46uyjjw', $jws);


        $loader = new Loader();
        $loaded = $loader-&gt;loadAndVerifySignatureUsingKeyAndDetachedPayload(
            $jws,
            $key,
            ['RS256'],
            $payload,
            $index
        );

        $this-&gt;assertInstanceOf(JWSInterface::class, $loaded);
        $this-&gt;assertEquals(0, $index);
        $this-&gt;assertEquals($protected_header, $loaded-&gt;getSignature(0)-&gt;getProtectedHeaders());

    }

</code></pre>

<p>Note this test uses the <code>{"alg":"RS256","b64":false,"crit":["b64"]}</code> header and <code>$.02</code> as the unencoded payload.</p>
<p>The input of the signing function should match <code>eyJhbGciOiJSUzI1NiIsImI2NCI6ZmFsc2UsImNyaXQiOlsiYjY0Il19.$.02</code>
and the resulting signature should match <code>eyJhbGciOiJSUzI1NiIsImI2NCI6ZmFsc2UsImNyaXQiOlsiYjY0Il19..fZRkjTTrcXdUovHjghM6JvlMhJuR1s8X1F4Uy_F4oMhZ9KtF2Zp78lYSOI7OxB5uoTu8FpQHvy-dz3N4nLhoSWAi2_HrxZG_2DyctUUB_8pRKYBmIdIgpOlEMjIreOvXyM6A32gR-PdbzoQq14yQbbfxk12jyZSwcaNu29gXnW_uO7ku1GSV_juWE5E_yIstvEB1GG8ApUGIuzRJDrAAa8KBkHN7Rdfhc8rJMOeSZI0dc_A-Y7t0M0RtrgvV_FhzM40K1pwr1YUZ5y1N4QV13M5u5qJ_lBK40WtWYL5MbJ58Qqk_-Q8l1dp6OCmoMvwdc7FmMsPigmyklqo46uyjjw</code></p>
<p>Our prototypes successfully matched this testcase, and matched results on JSON-LD claim inputs.</p>
<h2 id="creating-json-ld-signatures-with-json-ld-rsa-2017-signature-suite">Creating JSON-LD signatures with JSON-LD RSA 2017 Signature Suite</h2>
<h3 id="overview">Overview</h3>
<p>Starting with a JSON-LD document, we want to produce a JSON Web Signature:</p>
<ol>
<li>Normalize the JSON-LD with the URDNA2015 algorithm (now called GCA2015)</li>
<li>SHA256 hash the normalized JSON-LD</li>
<li>Use the hash as the input for JWS signature with the header <code>{"alg":"RS256","b64":false,"crit":["b64"]}</code></li>
<li>Create a new key <code>signatureValue</code> in the JSON-LD document and use the
   generated signature as its value.</li>
</ol>
<h3 id="detailed-steps">Detailed steps</h3>
<p>This describes the detailed signing steps, including processing due to lack of JWS library support for detached payloads.</p>
<p>The signing flow is identical to other signature suites in the <a href="https://github.com/digitalbazaar/jsonld-signatures">JSON-LD signature library</a>; the only modifications required are in the <code>createSignature</code> function. A new algorithm, <code>RsaSignature2017</code>, was added to implement this signature suite.</p>
<p><strong>Note</strong> A proper implementation would recraft these steps as a JWS detached signature library, as opposed to including these steps in a JSON-LD signature library.</p>
<p>Inputs:</p>
<ul>
<li>JSON-LD headers (nonce, created, creator, ...) same as before. Algorithm should be <code>RsaSignature2017</code> </li>
<li>JSON-LD document</li>
</ul>
<p>JSON-LD Signing Algorithm:</p>
<ul>
<li>ensure algorithm is in accepted set</li>
<li>add 'created' date of now, if not supplied</li>
<li>canonicalize using the <code>GCA2015</code> algorithm (formerly<code>URDNA2015</code>)</li>
<li><strong>Perform RSA Signature Suite 2017 signing</strong></li>
<li>compact the signature</li>
<li>return the JSON-LD document with the signature block added</li>
</ul>
<h3 id="rsa-signature-suite-2017-signatures">RSA Signature Suite 2017 signatures</h3>
<p><strong>Note/TODO</strong> Our prototypes omit the call to <code>_getDataToHash</code>, which prefixes the JSON-LD normalized document with the sorted header key/values <code>created</code>, <code>domain</code>, and <code>nonce</code> (all that are supplied). We need to decide whether to use that approach, or to rely on JWS headers (if protected headers, they are part of the signed payload)</p>
<p>This approach uses JOSE JWS detached payload signing, as described in <a href="https://tools.ietf.org/html/rfc7797">RFC 7797</a>. The JWS headers to use are:</p>
<pre><code>protectedHeaders = {
    &quot;alg&quot;:&quot;RS256&quot;,
    &quot;b64&quot;:false,
    &quot;crit&quot;:[&quot;b64&quot;]
}
</code></pre>

<p>This will be a protected header, meaning it is part of the signature. JOSE JWS detached payload signing expects the following input:</p>
<pre><code>ASCII(BASE64URL(UTF8(JWS Protected Header)) || '.' || JWS Payload  
</code></pre>

<p>Let's break apart the protected header handling into the steps:</p>
<ul>
<li>stringify the protected header JSON, sorting the keys. <ul>
<li>sorting is an implementation choice to allow predictability</li>
</ul>
</li>
<li>encode the stringified header as follows:<ul>
<li>utf-8 encode</li>
<li>base64 url encode</li>
<li>ascii encode</li>
</ul>
</li>
</ul>
<p>To sign, we do the following steps, where <code>input</code> is the normalized JSON-LD.</p>
<ul>
<li>form the JWS input to sign as <header> + "." + <input></li>
<li>RSASHA256 sign the JWS input.</li>
<li>base64 url encode the signature value</li>
<li>form the complete signature to be placed in <code>signatureValue</code> as <header> + ".." + <base64Signature><ul>
<li>In JWS, the payload would normally be between the middle 2 dots, but this is a detached payload</li>
<li>Note that the header is included in the signature, so the sorting done in the first step isn't technically necessarily. Verification would need to ensure it uses the same encoded header.</li>
</ul>
</li>
</ul>
<h2 id="steps-to-verify">Steps to verify</h2>
<p>We have not implemented the verification algorithm so this is just a tentative
description of what should happen:</p>
<ol>
<li>Remove the <code>signature</code> from the JSON-LD document</li>
<li>Normalize the resulting JSON-LD document (without the <code>signatureValue</code> key)</li>
<li>SHA256 hash the normalized JSON-LD</li>
<li>Use the hash and the payload as inputs to JWS verification algorithm</li>
</ol>
<h2 id="problems-encountered">Problems encountered</h2>
<h3 id="lack-of-jws-detached-payload-library-support">Lack of JWS detached payload library support</h3>
<p>As described above, the only library we found that supports detached payloads was the <a href="https://github.com/Spomky-Labs/jose">PHP JOSE</a> library. </p>
<h3 id="consistent-ordering-of-jws-headers">Consistent ordering of JWS headers</h3>
<p>To our knowledge the JOSE specs do not specify how json headers should be ordered. In our implementations, we ensured consistent lexicographical sorting of JWS headers. This is not critical since the encoded header is included in the signature, but our goal was to produce consistent signatures (similar to what's done in <code>_getDataToHash</code>.</p>
<p>Specifying the sorting of the keys, the separators and the encoding should be enough for any implementation to be able to produce the same signature.</p>
<p>Example in python:</p>
<pre><code class="python">import json

header = {'alg': 'RS256', 'b64': False, 'crit': ['b64']}

# stringify json
# there are no guarantees about the ordering of the keys and the separators use
# a whitespace between the keys
json.dumps(header)
'{&quot;crit&quot;: [&quot;b64&quot;], &quot;alg&quot;: &quot;RS256&quot;, &quot;b64&quot;: false}'

# we can specify the separators. In this case we say we don't want whitespaces
json.dumps(header, separators=(',', ':'))
'{&quot;crit&quot;:[&quot;b64&quot;],&quot;alg&quot;:&quot;RS256&quot;,&quot;b64&quot;:false}'

# and we can specify the ordering of the keys
json.dumps(header, separators=(',', ':'), sort_keys=True)
'{&quot;alg&quot;:&quot;RS256&quot;,&quot;b64&quot;:false,&quot;crit&quot;:[&quot;b64&quot;]}'

# ultimately we can specify the encoding to use and return a bytestring that
can then be used to base64 encode / sign / hash
json.dumps(header, separators=(',', ':'), sort_keys=True).encode('utf-8')
b'{&quot;alg&quot;:&quot;RS256&quot;,&quot;b64&quot;:false,&quot;crit&quot;:[&quot;b64&quot;]}'
</code></pre>

<h2 id="modifications-to-javascript-json-ld-signature-library-to-support-rsasignature2017">Modifications to javascript JSON-LD signature library to support <code>RsaSignature2017</code></h2>
<p>The only modifications are:
- Add new algorithm <code>RsaSignature2017</code>
- Add new path to <code>_createSignature</code> to support <code>RsaSignature2017</code>
- TBD additional JSON-LD headers (nonce, created, creator, ...)</p>
<pre><code>if(options.algorithm === 'RsaSignature2017') {
    var crypto = api.use('crypto');
    var signer = crypto.createSign('RSA-SHA256');

    // detached signature headers for JWS
    var protectedHeader = {&quot;alg&quot;:&quot;RS256&quot;,&quot;b64&quot;:false,&quot;crit&quot;:[&quot;b64&quot;]};

    // ensure the stringified version of the protected header has a consistent ordering
    var stringifiedHeader = JSON.stringify(protectedHeader, Object.keys(protectedHeader).sort());

    // utf-8 encode and base64 url encode the protected header.
    // Note that base64url.encode does the following, and Buffer(str) default encoding is utf-8:
    // new Buffer(str).toString('base64')
    var b64UrlEncodedHeader = base64url.encode(stringifiedHeader);

    // ensure resulting string is ascii
    var asciiHeader = Buffer.from(b64UrlEncodedHeader, 'utf-8').toString('ascii');

    // jws input to sign
    var to_sign = asciiHeader + &quot;.&quot; + input;

    signer.update(to_sign);
    var signatureBytes = signer.sign(options.privateKeyPem);

    var base64Signature = base64url.encode(signatureBytes);

    // JWS signature is encoded proctected header + '..' + signature
    // .. is because this is a detached payload
    signature = b64UrlEncodedHeader + &quot;..&quot; + base64Signature;
}
</code></pre>

<p><strong>Reminder</strong> These steps should not be implemented directly in the JSON-LD signatures library; instead they should be refactored into a JWS detached payload library.</p>

  <br>
</div>

<footer class="col-md-12 wm-page-content"><p>All of the contents of this directory are licensed CC-BY their contributors, unless otherwise noted.</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>